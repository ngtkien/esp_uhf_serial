<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Dashboard - BMS System </title>
    <!-- CSS files -->
    <link href="./styles.css" rel="stylesheet">
    <style type="text/css">
      .apexcharts-canvas {
        position: relative;
        user-select: none;
        /* cannot give overflow: hidden as it will crop tooltips which overflow outside chart area */
      }


      

      .apexcharts-tooltip {
        border-radius: 5px;
        box-shadow: 2px 2px 6px -4px #999;
        cursor: default;
        font-size: 14px;
        left: 62px;
        /* opacity: 0; */
        pointer-events: none;
        position: absolute;
        top: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        white-space: nowrap;
        z-index: 12;
        transition: 0.15s ease all;
      }
      .svg_select_boundingRect,
      .svg_select_points_rot {
        pointer-events: none;
        opacity: 0;
        visibility: hidden;
      }
      .svg_select_points {
        fill: #efefef;
        stroke: #333;
        rx: 2;
      }




      .resize-triggers {
        animation: 1ms resizeanim;
        visibility: hidden;
      }

      .resize-triggers,
      .resize-triggers>div,


      .resize-triggers>div {
        background: #eee;
        overflow: auto;
      }

    </style>
    <style>
      wordsmine:not(.wm-nohighlight) {
        color: #222b54;
        background-color: #ffc100;
        position: relative;
        display: inline-block;
      }

      a wordsmine,
      button wordsmine {
        color: currentColor;
        background: unset;
      }
    </style>
  </head>
  <body class="theme-light" data-gr-ext-installed="">
    <div class="wrapper">
      <aside class="navbar navbar-vertical navbar-expand-lg navbar-dark">
        <div class="container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <h1 class="navbar-brand navbar-brand-autodark"></h1>
          <div class="navbar-nav flex-row d-lg-none">
            <div class="nav-item d-none d-md-flex me-3">
              <!-- <div class="btn-list"></div> -->
            </div>
            <div class="nav-item dropdown d-none d-md-flex me-3">
              <div class="dropdown-menu dropdown-menu-end dropdown-menu-card">
                <div class="card">
                  <!-- <div class="card-body"></div> -->
                </div>
              </div>
            </div>
            <!-- <div class="nav-item dropdown"></div> -->
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="navbar-nav pt-lg-3">
              <li class="nav-item"></li>
              <li class="nav-item dropdown">
                <div class="dropdown-menu show" data-bs-popper="none">
                  <div class="dropdown-menu-columns">
                    <div class="dropdown-menu-column">
                      <a class="dropdown-item"> Trang Chủ </a>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link">
                  <span class="nav-link-icon d-md-none d-lg-inline-block">
                    <!-- Download SVG icon from http://tabler-icons.io/i/checkbox -->
                  </span>
                  <span class="nav-link-title"> Forms </span>
                </a>
              </li>
              <li class="nav-item dropdown">
                <div class="dropdown-menu show" data-bs-popper="none">
                  <a class="dropdown-item"> Hoạt động </a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </aside>
      <div class="page-wrapper">
        <div class="container-fluid">
          <!-- Page title -->
          <div class="page-header d-print-none">
            <div class="row align-items-center">
              <div class="col">
                <!-- Page pre-title -->
                <!-- <div class="page-pretitle"> Overview </div> -->
                <h2 class="page-title"> BMS  </h2>
              </div>
              <!-- Page title actions -->
              <div class="col-auto ms-auto d-print-none">
                <!-- <div class="btn-list"></div> -->
              </div>
            </div>
          </div>
        </div>
        <div class="page-body">
          <div class="container-fluid">
            <div class="row row-deck row-cards">
              <div class="col-sm-6 col-lg-3">
                <div class="card">
                  <div class="card-body" style="min-height: 240px;"><h3 style="min-height: 40px;">Thông tin thiết bị</h3>
                    <div class="d-flex align-items-baseline">
                      <div>
                        <!-- <p class="h2 mb-3 me-0" ></p>Board: <strong>ESP32 DevKit-C</strong> -->
                        <p class="h2 mb-2 me-0" ></p>Bộ nhớ: <strong>16MB</strong>
                        <p class="h2 mb-2 me-0" ></p>Tổng số khay: <strong>5</strong> 
                      </div>
                    </div>
                  </div>
                  <div class="card-body" style="min-height: 240px;"><h2 style="min-height: 40px;">Kiểm tra thiết bị</h2>
                    <div class="ms-5 d-inline-block">

                      <h4>Trạng thái đèn LED</h4>
                      <span id="led_state">-</span>
                      <p><button id="button" class="btn btn-primary">Bật/Tắt đèn LED</button></p>
                      
                      <h4>Điều khiển còi</h4>
                      <p><button id="button_beep" class="btn btn-primary">Beep</button></p>
                      <!-- <p >Độ trễ: <span id="delay">-</span>giây</p>
                      Thiết lập độ trễ: 
                      <button style="position: relative; top: 34px; left: 0px;" id="delay_set" class="btn btn-primary">Set</button>
                      <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input" minlength="2" maxlength="2" size="5" > 
                      -->
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="card">
                  <div class="card-body" style="position: relative;">
                    <div class="d-flex align-items-center"> <h3 style="min-height: 40px;">Thiết lập khoảng cách cho đầu đọc</h3>
                    </div>
                    <div class="d-flex align-items-baseline">
                      <div class="h4 mb-3 me-2">
                        <p style="position:relative; left:30px; ">Mức Độ lợi Ăn-ten: <strong><span id="gain">-</span></strong></p>
                        <button id="button_pow" class="btn btn-primary" style="position: relative; left:100px ">Đọc độ lợi</button>
                        <form>
                          <p><label style="position:relative; left:30px; top: 20px;"><strong>Thiết lập độ lợi:</strong></label></p>
                          <select style="position:relative; left:55px; top: 20px" id="gain_set">
                          <option value="selectcard">--- Vui lòng chọn ---</option>
                          <option value=0>0</option>
                          <option value=1>1</option>
                          <option value=2>2</option>
                          <option value=3>3</option>
                          </select>
                        </form>
                        <button style="position: relative; top: 40px; left:60%" id="set_pow" class="btn btn-primary">Cài đặt độ lợi</button>
                      </div> 
                    </div>
                  </div>
                  <div class="card-body" style="position: relative;">
                    <div class="d-flex align-items-center"> <h3>Chức năng hiện tại</h3>
                    </div>
                    <div class="d-flex align-items-baseline"  style="min-height: 20px;">
                      <h3 style="position: relative; top: 10px; left:100px; min-width: none;"><strong><span id="function">Điều Khiển Hệ Thống</span></strong></h3>
                      </div>
                    <div class="d-flex align-items-baseline"  style="min-height: 80px;">
                      <a class="btn btn-white" style="position: relative; top: 50px; left: 75px;" id="fn_normal">Đổi trạng thái hoạt động</a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="row row-cards">
                  <div class="col-12">
                    <a class="card card-sponsor target="_blank" rel="noopener" aria-label="Sponsor Tabler!">
                      <div class="card-body" style="position: relative;">
                        <div class="d-flex align-items-center"><h3>Thao Tác Thẻ</h3>
                        </div>
                        <div class="d-flex align-items-baseline" style="min-height: 200px;">
                          <form >
                            <p><label>
                              Chế độ này chỉ hoạt động khi thiết bị ở trạng thái <strong>Đọc và ghi thẻ</strong>
                            </label></p>
                            <p><lable style="position:relative; left:30px; ">Mã số thẻ: <input class="input" type="text" id ="epc_tag" type="text" minlength="24" maxlength="24" size="30" name="epc_tag" style="position:relative; left: 30px; top:30px; "></lable></p>
                            <label  style="position:relative; left:30px; top: 30px" for="room">Chọn ô để lưu mã số thẻ:</label>
                            
                            <select id="storage" style="position:relative;top:0px;left:80px; top: 30px">
                            <option value="selectcard">--- Vui lòng chọn ô ---</option>
                            <option value=1>1</option>
                            <option value=2>2</option>
                            <option value=3>3</option>
                            <option value=4>4</option>
                            <option value=5>5</option>
                            <option value=6>6</option>
                            <option value=7>7</option>
                            <option value=8>8</option>
                            <option value=9>9</option>
                            <option value=10>10</option>
                            <option value=11>11</option>
                            <option value=12>12</option>
                            <option value=13>13</option>
                            <option value=14>14</option>
                            <option value=15>15</option>
                            <option value=16>16</option>         
                            </select>
                            
                          </form><br>
                          <button id="btn_save" class="btn btn-primary" style="position: relative; top: 170px; right: 100px">Lưu</button>
                           
                           
                        </div>
                        <div class="d-flex align-items-baseline" style="min-height: 200px;">
                          <p><lable style="position:relative; top: 60px; left:30px; ">Ô đang chứa: <input class="input" type="text" id ="epc_tag_storage" type="text" minlength="24" maxlength="24" size="30" name="epc_tag_storage" style="position:relative; left: 10px; top:30px; "></lable></p>
                          <p><button id="btn_find_tags" class="btn btn-primary" style="position: relative; top: 90px; left:50px;">Tìm</button>
                          <p><button id="btn_delete_tags" class="btn btn-primary" style="position: relative; top: 90px; left:60px;">Xóa Thẻ</button>
                          </p>
                        </div>
                      </div>
                    </a>
                  </div>
                  <!-- <div class="col-12">
                    <div class="card">
                      <a class="card card-sponsor target="_blank" rel="noopener" aria-label="Sponsor Tabler!">
                        <div class="d-flex align-items-center"><h3></h3>
                          
                        </div>
                        <div class="d-flex align-items-baseline" style="min-height: 100px;">

                        </div>
                      
                      </a>
                    </div>
                  </div> -->
                </div>
              </div>
              <div class="col-lg-6">
                <a class="card card-sponsor target="_blank" rel="noopener" aria-label="Sponsor Tabler!">
                  <div class="position-relative">
                    <div class="card-body" style="min-height: 280px; ">
                      <h2 style="min-height: 40px;">Quản lý bộ nhớ</h2>
                      
                      <div class="d-flex align-items-baseline" style="min-height: 150px;">
                        <form >
                          <label  style="position:relative; left:30px; top: 30px" for="room">Chọn ô cần xóa dữ liệu:</label>
                          <select id="erase_storage" style="position:relative;top:0px;left:80px; top: 30px">
                          <option value="selectcard">--- Vui lòng chọn ô ---</option>
                          <option value=1>1</option>
                          <option value=2>2</option>
                          <option value=3>3</option>
                          <option value=4>4</option>
                          <option value=5>5</option>
                          <option value=6>6</option>
                          <option value=7>7</option>
                          <option value=8>8</option>
                          <option value=9>9</option>
                          <option value=10>10</option>
                          <option value=11>11</option>
                          <option value=12>12</option>
                          <option value=13>13</option>
                          <option value=14>14</option>
                          <option value=15>15</option>
                          <option value=16>16</option> 
                          </select>
                         </form>
                         <button id="btn_erase" class="btn btn-primary" style="position: relative; top: 80px; right: 110px">Xóa ô nhớ</button>
                      </div>  
                      <div class="d-flex align-items-baseline" style="min-height: 150px;">                       
                         <form >
                          <label  style="position:relative; left:30px; top: 30px" for="room">Chọn ô nhớ để xem số lượng thẻ đang lưu</label>
                          <select id="get_storage" style="position:relative;top:0px;left:80px; top: 30px">
                            <option value="selectcard">--- Vui lòng chọn ô ---</option>
                            <option value=1>1</option>
                            <option value=2>2</option>
                            <option value=3>3</option>
                            <option value=4>4</option>
                            <option value=5>5</option>
                            <option value=6>6</option>
                            <option value=7>7</option>
                            <option value=8>8</option>
                            <option value=9>9</option>
                            <option value=10>10</option>
                            <option value=11>11</option>
                            <option value=12>12</option>
                            <option value=13>13</option>
                            <option value=14>14</option>
                            <option value=15>15</option>
                            <option value=16>16</option> 
                          </select>
                          </form><br>                         
                          <label>
                            <input class="input" type="text" id ="storage_size" type="text" minlength="12" maxlength="12" size="12" style="position:relative; left:-80px; top:60px; ">
                          </label>
                          <button id="btn_get_storage" class="btn btn-primary"  style="position: relative; top: 60px; left:-50px">Kiểm tra</button>
                    </div>
                    <style>
                      .divider {
                          border-top: 1px solid black;
                          margin-top: 20px;
                          margin-bottom: 20px;
                      }
                    </style>
                  
                    <div class="divider"></div>
                    <div class="card-body" style="min-height: 280px; ">
                      <h2 style="min-height: 40px;"> Cập nhật WIFI</h2>
                      <div class="form-group">
                        <label for="ssid">SSID:</label>
                        <input type="text" class="form-control" id="ssid" placeholder="Enter SSID">
                      </div>
                      <div class="form-group">
                          <label for="password">Password:</label>
                          <input type="password" class="form-control" id="password" placeholder="Enter password">
                      </div>
                      <button style="margin-top: 20px;" type="button" class="btn btn-primary" id="update_wifi" >Update</button>

                    </div>
                  </div>
                </div>
              </a>
            </div>
              <div class="col-sm-5 col-lg-6" >
                <a class="card card-sponsor" target="_blank" rel="noopener" aria-label="Sponsor Tabler!" >
                  <div class="row" style="text-align: center;">
                    <h3 style="min-height: 40px; position: center; margin-top: 10px;" >Thiết lập độ trễ đóng mở khay sau khi quẹt thẻ</h3>  
                    <label>Độ trễ cho từng khay tương ứng với số thứ tự</label>
                  </div style="margin-top: 10px;">
                  <div class="row" style="text-align: center;">
                    <div class="col-sm-6" style="position: right; ">
                      <center>
                            <p>Độ trễ 1: <span id="delay1">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input1" minlength="2" maxlength="2" size="5"> 
                              </p>
                              <p >Độ trễ 2: <span id="delay2">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input2" minlength="2" maxlength="2" size="5"> 
                              </p>
                              <p >Độ trễ 3: <span id="delay3">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input3" minlength="2" maxlength="2" size="5"> 
                              </p>
                              <p >Độ trễ 4: <span id="delay4">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input4" minlength="2" maxlength="2" size="5"> 
                              </p>
                              <p >Độ trễ 5: <span id="delay5">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input5" minlength="2" maxlength="2" size="5"> 
                              </p>
                              <p >Độ trễ 5: <span id="delay5">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input5" minlength="2" maxlength="2" size="5"> 
                              </p>
                              <p >Độ trễ 6: <span id="delay6">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input6" minlength="2" maxlength="2" size="5"> 
                              </p>
                              <p >Độ trễ 7: <span id="delay7">1</span> giây
                              <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input7" minlength="2" maxlength="2" size="5"> 
                              <p >Độ trễ 8: <span id="delay8">1</span> giây
                                <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input8" minlength="2" maxlength="2" size="5"> 
                                </p>
                            </p>
                      </center>
                    </div>
                    <div class="col-sm-6" style="position: left;">
                      <center>
                        
                          <p >Độ trễ 9: <span id="delay9">1</span> giây
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input9" minlength="2" maxlength="2" size="5"> 
                          </p>
                          <p >Độ trễ 10: <span id="delay10">1</span> giây
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input10" minlength="2" maxlength="2" size="5"> 
                          </p>
                          <p >Độ trễ 11: <span id="delay11">1</span> giây
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input11" minlength="2" maxlength="2" size="5"> 
                          </p>
                          <p >Độ trễ 12: <span id="delay12">1</span> giây
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input12" minlength="2" maxlength="2" size="5"> 
                          </p>
                          <p >Độ trễ 13: <span id="delay13">1</span> giây
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input13" minlength="2" maxlength="2" size="5"> 
                          </p>
                          <p >Độ trễ 14: <span id="delay14">1</span> giây
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input14" minlength="2" maxlength="2" size="5"> 
                          </p>
                          <p >Độ trễ 15: <span id="delay15">1</span> giây
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input15" minlength="2" maxlength="2" size="5"> 
                          </p>
                          <p >Độ trễ 16: <span id="delay16">1</span> giây
                          </p>
                          <input style="position: relative; top: 10px" type="text" class="form-control form-control-sm" id="delay_input16" minlength="2" maxlength="2" size="5"> 
                          </p>
                      </center>

                    </div>
                  </div>
                  <div style="text-align: center; margin-bottom: 20px; margin-top: 10px;">
                    <button style="position: center; top: 10px; left: 100px;" id="delay_set" class="btn btn-primary">Cài đặt độ trễ</button>
                    <button style="position: center; top: 10px; left: 100px;" id="delay_get" class="btn btn-primary">Đọc độ trễ hiện tại</button>
                  </div>
                  
                  
                </a>
              </div>

            </div>
          </div>
        </div>
        <footer class="footer footer-transparent d-print-none">
          <div class="container-fluid">
            <div class="row text-center align-items-center flex-row-reverse">
              <div class="col-lg-auto ms-lg-auto"></div>
              <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                <ul class="list-inline list-inline-dots mb-0"></ul>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <div class="modal modal-blur fade" id="modal-report" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">New report</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" name="example-text-input" placeholder="Your report name">
            </div>
            <label class="form-label">Report type</label>
            <div class="form-selectgroup-boxes row mb-3">
              <div class="col-lg-6">
                <label class="form-selectgroup-item">
                  <input type="radio" name="report-type" value="1" class="form-selectgroup-input" checked="">
                  <span class="form-selectgroup-label d-flex align-items-center p-3">
                    <span class="me-3">
                      <span class="form-selectgroup-check"></span>
                    </span>
                    <span class="form-selectgroup-label-content">
                      <span class="form-selectgroup-title strong mb-1">Simple</span>
                      <span class="d-block text-muted">Provide only basic data needed for the report</span>
                    </span>
                  </span>
                </label>
              </div>
              <div class="col-lg-6">
                <label class="form-selectgroup-item">
                  <input type="radio" name="report-type" value="1" class="form-selectgroup-input">
                  <span class="form-selectgroup-label d-flex align-items-center p-3">
                    <span class="me-3">
                      <span class="form-selectgroup-check"></span>
                    </span>
                    <span class="form-selectgroup-label-content">
                      <span class="form-selectgroup-title strong mb-1">Advanced</span>
                      <span class="d-block text-muted">Insert charts and additional advanced analyses to be inserted in the report</span>
                    </span>
                  </span>
                </label>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-8">
                <div class="mb-3">
                  <label class="form-label">Report url</label>
                  <div class="input-group input-group-flat">
                    <span class="input-group-text"> https://tabler.io/reports/ </span>
                    <input type="text" class="form-control ps-0" value="report-01" autocomplete="off">
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="mb-3">
                  <label class="form-label">Visibility</label>
                  <select class="form-select">
                    <option value="1" selected="">Private</option>
                    <option value="2">Public</option>
                    <option value="3">Hidden</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-lg-6">
                <div class="mb-3">
                  <label class="form-label">Client name</label>
                  <input type="text" class="form-control">
                </div>
              </div>
              <div class="col-lg-6">
                <div class="mb-3">
                  <label class="form-label">Reporting period</label>
                  <input type="date" class="form-control">
                </div>
              </div>
              <div class="col-lg-12">
                <div>
                  <label class="form-label">Additional information</label>
                  <textarea class="form-control" rows="3"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer"></div>
        </div>
      </div>
    </div>
    <script>
      var gateway = `ws://${window.location.hostname}/ws`;
      var websocket;
      window.addEventListener('load', onLoad);
      function initWebSocket() {
        console.log('Trying to open a WebSocket connection...');
        websocket = new WebSocket(gateway);
        websocket.onopen    = onOpen;
        websocket.onclose   = onClose;
        websocket.onmessage = onMessage; // <-- add this line
      }
      function onOpen(event) {
        console.log('Connection opened');
      }
      function onClose(event) {
        console.log('Connection closed');
        setTimeout(initWebSocket, 2000);
      }
      //TODO: Receive Message from ESP32
      function onMessage(event) {
        //parse data -> json
        let data = JSON.parse(event.data);
        console.log(data);
        if(data.action == "init"){
          
          if(data.led_status =="ON"){
            document.getElementById('led_state').innerHTML = "ĐANG BẬT";
          }
          else {
            document.getElementById('led_state').innerHTML = "ĐANG TẮT";
          }
          document.getElementById('gain').innerHTML = data.gain;
          //document.getElementById("function").innerHTML = data.mode;
          if(data.mode == "Normal"){
            document.getElementById("function").innerHTML = "Điều Khiển Hệ Thống";
          }
          else {
            document.getElementById("function").innerHTML = "Đọc và ghi thẻ";
          }
        }
        if(data.action == "led_toggle"){
  //Handle by key
          // document.getElementById('led_state').innerHTML = data.led_status;
          if(data.led_status =="ON"){
            document.getElementById('led_state').innerHTML = "ĐANG BẬT";
          }
          else {
            document.getElementById('led_state').innerHTML = "ĐANG TẮT";
          }
        }
        if(data.action == "set_gain"){
          if(data.status){
            alert("Ghi độ lợi thành công");
          } 
          else {
            alert("Ghi độ lợi không thành công");
          }
        }
        if(data.action == "get_gain"){
          document.getElementById('gain').innerHTML = data.gain;
        }
        if(data.action == "change_mode"){
          if(data.mode == "Normal"){
            document.getElementById("function").innerHTML = "Điều Khiển Hệ Thống";
          }
          else {
            document.getElementById("function").innerHTML = "Đọc và ghi thẻ";
          }
        }
        if(data.action == "post_epc"){
          document.getElementById("epc_tag").value = data.epc;
        }
        if(data.action == "delay"){
          if(data.status){
            alert("Ghi độ trễ thành công");
          } 
          else {
            alert("Ghi độ trễ không thành công");
          }
        }
        if(data.action ==  "delay_get"){
          document.getElementById("delay1").innerHTML = data.value[0];
          document.getElementById("delay2").innerHTML = data.value[1];
          document.getElementById("delay3").innerHTML = data.value[2];
          document.getElementById("delay4").innerHTML = data.value[3];
          document.getElementById("delay5").innerHTML = data.value[4];
          document.getElementById("delay6").innerHTML = data.value[5];
          document.getElementById("delay7").innerHTML = data.value[6];
          document.getElementById("delay8").innerHTML = data.value[7];
          document.getElementById("delay9").innerHTML = data.value[8];
          document.getElementById("delay10").innerHTML = data.value[9];
          document.getElementById("delay11").innerHTML = data.value[10];
          document.getElementById("delay12").innerHTML = data.value[11];
          document.getElementById("delay13").innerHTML = data.value[12];
          document.getElementById("delay14").innerHTML = data.value[13];
          document.getElementById("delay15").innerHTML = data.value[14];
          document.getElementById("delay16").innerHTML = data.value[15];
        }
        if(data.action == "save_tags"){
          if(data.status){
            alert("Ghi thành công");
          }
          else {
            alert("Ghi không thành công\n Thẻ bị trùng hoặc bộ nhớ đầy ( > 99)\n");
          }
        }
        if(data.action == "erase" ){
          if(data.status){
            alert("Xóa ô nhớ thành công");
          }
          else {
            alert("Xóa ô nhớ không thành công");
          }
        }
        if(data.action == "get_storage"){
          document.getElementById("storage_size").value = data.size;
        }
        if(data.action == "find_tags") {
          if(data.status){
            alert("Tìm thấy thẻ thành công");
            document.getElementById("epc_tag_storage").value = data.index_room;
          }
          else {
            alert("Không tìm thấy thẻ");
          }
        }
        if(data.action == "delete_tags"){
          if(data.status){
            alert("Xóa thẻ thành công");
          }
          else {
            alert("Xóa thẻ không thành công");
          }
        }
        if(data.action == "update_wifi"){
          if(data.status){
            alert("Cập nhật wifi thành công. Thiết bị khởi động lại sau 3 giấy");
          }
          else {
            alert("Cập nhật không thành công");
          }
        } 
      }
      function onLoad(event) {
        initWebSocket();
        initButton();
      }
      //TODO: Init for button
      function initButton() {
        document.getElementById('button').addEventListener('click', toggle_led);
        document.getElementById('btn_save').addEventListener('click', save_tags);
        document.getElementById('fn_normal').addEventListener('click', change_fn);
        document.getElementById('delay_set').addEventListener('click',fn_delay_set);
        document.getElementById('delay_get').addEventListener('click',delay_get);
        document.getElementById('btn_erase').addEventListener('click',erase_strage_fn);
        document.getElementById('btn_get_storage').addEventListener('click',get_strage_fn);
        document.getElementById('button_beep').addEventListener('click',on_buzzer);
        document.getElementById('btn_find_tags').addEventListener('click',finds_tags_storage_index);
        document.getElementById('btn_delete_tags').addEventListener('click',delete_tags_storage_index);
        document.getElementById('set_pow').addEventListener('click', set_gain);
        document.getElementById('button_pow').addEventListener('click', get_gain);
        document.getElementById('update_wifi').addEventListener('click', fn_update_wifi);
      }

      //TODO: send backend -> toggle led
      function toggle_led(){
        //web send to esp32
        websocket.send(JSON.stringify({'action':'toggle_led'}));
      }
      //TODO: send backend ->Change mode device
      function change_fn(){
           websocket.send(JSON.stringify({'action':'change_mode'}));          
      }

      //TODO: send backend -> get gain
      function get_gain(){
        //web send to esp32
        //websocket.send('getpow');
        websocket.send(JSON.stringify({'action':'get_gain'}));
        
      }
      //TODO: send backend -> set gain
      function set_gain(){
    
        let pow =  document.getElementById('gain_set');
        var selectedValue = pow.options[pow.selectedIndex].value;
        if (selectedValue == "selectcard" )
        {
            alert("Vui lòng chọn mức độ lợi");
            return;
        }
        websocket.send(JSON.stringify({'action':'set_gain',
      'gain':parseInt(selectedValue)}));
      }
    
    
      //TODO: send backend -> save epc_tags 
      function save_tags(){
        let epc =  document.getElementById('epc_tag').value;
        let store =  document.getElementById('storage');
        var selectedValue = store.options[store.selectedIndex].value;
        if (epc.length < 12   || selectedValue == "selectcard" )
        {
            alert("Thẻ có độ dài < 12 và chưa chọn ô chứa");
            return;
        }
        console.log("epc: " + epc + " storage: " + selectedValue);
        websocket.send(JSON.stringify({'action':'save_tags','epc':epc,'room':parseInt(selectedValue)}));
      }

      function fn_update_wifi(){
        var ssid = document.getElementById("ssid").value;
        var password = document.getElementById("password").value;

        if (ssid === "" || password === "") {
            alert("Please enter both SSID and password.");
        } else {

            if (password.length <= 8) {
            alert("Password must be at least 8 characters long.");
            } else {
                // Do something with the ssid and password variables
                console.log("SSID: " + ssid);
                console.log("Password: " + password);
                websocket.send(JSON.stringify({'action':'update_wifi',
                              'ssid':ssid,'password':password}));
            }
            
        }
      }

      function fn_delay_set(){
        
        var delay1 =  document.getElementById('delay_input1').value;
        var delay2 =  document.getElementById('delay_input2').value;
        var delay3 =  document.getElementById('delay_input3').value;
        var delay4 =  document.getElementById('delay_input4').value;
        var delay5 =  document.getElementById('delay_input5').value;
        var delay6 =  document.getElementById('delay_input6').value;
        var delay7 =  document.getElementById('delay_input7').value;
        var delay8 =  document.getElementById('delay_input8').value;
        var delay9 =  document.getElementById('delay_input9').value;
        var delay10 =  document.getElementById('delay_input10').value;
        var delay11 =  document.getElementById('delay_input11').value;
        var delay12 =  document.getElementById('delay_input12').value;
        var delay13 =  document.getElementById('delay_input13').value;
        var delay14 =  document.getElementById('delay_input14').value;
        var delay15 =  document.getElementById('delay_input15').value;
        var delay16 =  document.getElementById('delay_input16').value;
        const msg = {}; // Object
        msg.action = 'delay';
        msg.value = []; // Array
        msg.value.push(parseInt(delay1));
        msg.value.push(parseInt(delay2));
        msg.value.push(parseInt(delay3));
        msg.value.push(parseInt(delay4));
        msg.value.push(parseInt(delay5));
        msg.value.push(parseInt(delay6));
        msg.value.push(parseInt(delay7));
        msg.value.push(parseInt(delay8));
        msg.value.push(parseInt(delay9));
        msg.value.push(parseInt(delay10));
        msg.value.push(parseInt(delay11));
        msg.value.push(parseInt(delay12));
        msg.value.push(parseInt(delay13));
        msg.value.push(parseInt(delay14));
        msg.value.push(parseInt(delay15));
        msg.value.push(parseInt(delay16));
        const json = JSON.stringify(msg);
        console.log(json);
        websocket.send(json);
      }
      function delay_get(){
        websocket.send(JSON.stringify({'action':'delay_get'}));
      }
      function erase_strage_fn(){
        let er_store =  document.getElementById('erase_storage');
        var selectedValue = er_store.options[er_store.selectedIndex].value;
        if (selectedValue == "selectcard" )
        {
            alert("Chọn ô nhớ cần xóa");
            return;
        }
        console.log("erase storage: " + selectedValue);
        websocket.send(JSON.stringify({'action':'erase','room':parseInt(selectedValue)}));
      
      }
      function get_strage_fn(){
        let er_store =  document.getElementById('get_storage');
        var selectedValue = er_store.options[er_store.selectedIndex].value;
        if (selectedValue == "selectcard" )
        {
            alert("Chọn ô nhớ cần xem");
            return;
        }
        console.log("get_storage: " + selectedValue);
        websocket.send(JSON.stringify({'action':'get_storage','room':parseInt(selectedValue)}));
      }
      function on_buzzer(){
        websocket.send(JSON.stringify({'action':'buzzer'}));
      }
      function finds_tags_storage_index() {
        let epc =  document.getElementById('epc_tag').value;
        if (epc.length < 12)
        {
            alert("Thẻ có độ dài < 12");
            return;
        }
        console.log("find storage of epc: " + epc);
        websocket.send(JSON.stringify({'action':'find_tags','epc':epc}));
      }
      function delete_tags_storage_index() {
        let epc =  document.getElementById('epc_tag').value;
        let store =  document.getElementById('epc_tag_storage');
        if (epc.length < 12)
        {
            alert("Thẻ có độ dài < 12");
            return;
        }
        console.log("find storage of epc: " + epc);
        websocket.send(JSON.stringify({'action':'delete_tags','epc':epc}));
      }
    </script>
  </body>
</html>